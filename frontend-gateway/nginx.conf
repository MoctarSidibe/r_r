# Micro Frontend Gateway Configuration
# Routes requests to appropriate micro frontends

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

upstream admin_frontend {
    server frontend-admin:80;
}

upstream candidate_frontend {
    server frontend-candidate:80;
}

upstream api_backend {
    server backend:80;
}

# Main server block
server {
    listen 80;
    server_name dgtt.local *.dgtt.local;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Admin micro frontend
    location /admin {
        proxy_pass http://admin_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Micro frontend specific headers
        proxy_set_header X-Micro-Frontend "admin";
        proxy_set_header X-User-Role "admin";
        
        # Timeout settings
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Candidate micro frontend
    location /candidate {
        proxy_pass http://candidate_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Micro frontend specific headers
        proxy_set_header X-Micro-Frontend "candidate";
        proxy_set_header X-User-Role "candidate";
        
        # Timeout settings
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # API backend routing
    location /api {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API specific headers
        proxy_set_header X-API-Version "v1";
        proxy_set_header X-Client-Type "web";
        
        # Timeout settings
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Default route - serve a proper homepage
    location / {
        # Serve a simple homepage instead of redirecting
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>DGTT Auto-École</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .container { max-width: 600px; margin: 0 auto; }
        .btn { display: inline-block; padding: 15px 30px; margin: 10px; 
               background: #007bff; color: white; text-decoration: none; 
               border-radius: 5px; }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DGTT Auto-École</h1>
        <p>Bienvenue sur la plateforme DGTT Auto-École</p>
        <a href="/admin" class="btn">Espace Administrateur</a>
        <a href="/candidate" class="btn">Espace Candidat</a>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 '{"status": "healthy", "timestamp": "$time_iso8601", "service": "frontend-gateway"}';
        add_header Content-Type application/json;
    }
}

}
